<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://esm.sh/@wooorm/starry-night@3/style/both">
    <base href="/">
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    </head>

<body class="antialiased font-sans bg-primary-50 dark:bg-primary-950 transition-colors"><header class="sticky top-0 left-2 w-full backdrop-blur bg-primary-200 dark:bg-primary-900/70 border-b border-primary-900/20 dark:border-primary-50/10 shadow-md dark:shadow-lg py-2 md:py-4 z-50"><nav class="mx-auto max-w-5xl px-4 md:px-8 xl:px-0 flex  items-center"><img src="/Content/Blog/media/avatar.svg" alt="Avatar image" class="inline-block h-10 w-10 md:h-12 md:w-12 mr-4  rounded-full shadow-md bg-gradient-to-br from-accent-800 to-accent-500 dark:from-accent-500 dark:to-accent-300">
        <h1><a class="font-extrabold text-2xl md:text-4xl text-primary-700 dark:text-primary-300" href="/">Thirty25</a></h1>
        <div class="ml-auto flex items-center"><button aria-label="Toggle Dark Mode" class="mr-6 dark:text-yellow-300 stroke-1 opacity-80" onclick="swapTheme()"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg></button>
            <a class="text-primary-600 hover:text-primary-300 transition-all hover:scale-105" title="Blog source" href="https://github.com/phil-scott-78/thirty25-statiq"><svg width="2rem" height="2rem" class="fill-current" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" transform="scale(64)"></path></svg></a></div></nav></header>

        <main class="mx-auto max-w-5xl px-4 md:px-8 xl:px-0 mt-4 mb-4 md:mb-16"><article><div class="xl:divide-y  xl:divide-primary-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt>
                        <dd class="text-base font-medium leading-6 text-primary-400"><time datetime="2022-05-12T00:00:00.000">May 12, 2022</time></dd></div></dl>
                <div class="prose prose-stone dark:prose-invert mx-auto"><h1 class>Adding Configuration to an Incremental Generator</h1></div></div></header>
        <div class="grid-rows-[auto_1fr] divide-y  pb-8 divide-primary-700 xl:grid xl:grid-cols-4 xl:gap-x-6 xl:divide-y-0"><div class="divide-y  divide-primary-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="prose prose-stone dark:prose-invert mt-8 prose-sm md:prose-base lg:prose-lg max-w-full dark:font-light lg:leading-loose"><p><a href="https://github.com/dotnet/roslyn/blob/main/docs/features/incremental-generators.md">Incremental Generators</a> solve a lot
of problems with performance of source generators. They add a layer of caching around the generator which drastically
improves performance. But to achieve this performance you need to play within a certain set of rules.</p>
<p>We must use <code>IncrementalGeneratorInitializationContext</code> to pull in our data via pipelines. By routing everything through
this object, the compiler can keep track of values used between builds and cache them. It has the follow providers:</p>
<ul>
<li>CompilationProvider</li>
<li>AdditionalTextsProvider</li>
<li>AnalyzerConfigOptionsProvider</li>
<li>MetadataReferencesProvider</li>
<li>ParseOptionsProvider</li>
</ul>
<p>Take this initializer from a generator. We are using the <code>AdditionalTextsProvider</code> to find all the razor files in a
project and extract CSS classes from them via a regular expression. We'll use <code>AdditionalTextsProvider</code> to access the
razor files. Because
we are accessing these files via this property, the compiler can keep track of which ones we are accessing and cache the
transforms.</p>
<pre><code class="language-csharp">public void Initialize(IncrementalGeneratorInitializationContext context)
{
    var cssClasses = context.AdditionalTextsProvider
        .Where(static value =&gt; value.Path.EndsWith(&quot;.cshtml&quot;) || value.Path.EndsWith(&quot;.razor&quot;))
        .Select(static (value, token) =&gt; value.GetText(token)!.ToString())
        .Select(static (value, _) =&gt;  Helpers.GetCssClassFromHtml(value, @&quot;(class\s*=\s*[\'\&quot;&quot;](?&lt;value&gt;[^&lt;]*?)[\'\&quot;&quot;])&quot;));

    context.RegisterSourceOutput(cssClasses, static (spc, source) =&gt; Execute(source, spc));
}
</code></pre>
<p>In this example we are accessing files with the extension <code>.cshtml</code> and <code>.razor</code>., extracting their full text and then
using a regular expression to parse out all the css classes. In a regular source generator this would be madness. We'd
have to parse every file constantly, dramatically slowing down the IDE. The caching of the incremental generator,
however, will make sure we only parse when the file changes. The are two obvious things that we want to configure - the
file extensions our generator cares about as well as the regular expression. An end user might also have some html files
they want to include, or maybe they have some custom components that use <code>cssclass</code> as the attribute.</p>
<p>To configure our value provider we can use <code>AnalyzerConfigOptionsProvider</code>. This works like the value provider for
AdditionalContext, but instead of looking at the files it looks at the config.</p>
<pre><code class="language-csharp">var config = context.AnalyzerConfigOptionsProvider.Select((provider, _) =&gt;
{
    var regex = @&quot;(class\s*=\s*[\'\&quot;&quot;](?&lt;value&gt;[^&lt;]*?)[\'\&quot;&quot;])&quot;;
    var additionalFileFilter = new[] { &quot;.cshtml&quot;, &quot;.razor&quot; };

    if (provider.GlobalOptions.TryGetValue(&quot;parser_regex&quot;, out var configValue))
        regex = configValue;

    if (provider.GlobalOptions.TryGetValue(&quot;parser_filter&quot;, out var fileFilter))
        additionalFileFilter = fileFilter.Split('|');

    return (Regex: regex, Filter: additionalFileFilter);
});
</code></pre>
<p>Here we are using the <code>TryGetValue</code> method to pull the two configuration values out and if we don't find them we'll fall
back to our defaults.</p>
<p>We now need to adjust our original value provider to use these values. We'll
use <a href="https://github.com/dotnet/roslyn/blob/main/docs/features/incremental-generators.md#combine"><code>Combine</code></a> to merge the
two providers together. This will create a tuple with a left and right side. The left side, the one calling combine,
will be the original value.
The right side will have the configuration.</p>
<p>Add just the combine call makes our <code>cssClasses</code> value provider now looks like this:</p>
<pre><code class="language-csharp">var cssClasses = context.AdditionalTextsProvider
    .Combine(config)
    .Where(static value =&gt; value.Left.Path.EndsWith(&quot;.cshtml&quot;) || value.Left.Path.EndsWith(&quot;.razor&quot;))
    .Select(static (value, token) =&gt; value.Left.GetText(token)!.ToString())
    .Select(static (value, _) =&gt;  Helpers.GetCssClassFromHtml(value, @&quot;(class\s*=\s*[\'\&quot;&quot;](?&lt;value&gt;[^&lt;]*?)[\'\&quot;&quot;])&quot;));
</code></pre>
<p>Note that now we are access <code>value.Left</code> to get at the <code>AdditionalTextProvider</code> values. <code>value.Right</code> contains our
configuration tuple.</p>
<p>We can now adjust our call to use that tuple instead.</p>
<pre><code class="language-csharp">var cssClasses = context.AdditionalTextsProvider
    .Combine(config)
    .Where(static value =&gt; value.Right.Filter.Any(i =&gt; value.Left.Path.EndsWith(i)))
    .Select(static (value, token) =&gt; (Config: value.Right, Content: value.Left.GetText(token)!.ToString()))
    .Select(static (value, _) =&gt;  Helpers.GetCssClassFromHtml(value.Content, value.Config.Regex));
</code></pre>
<p>Note that in the first <code>Select</code> we are creating a new tuple that passes the content and also the config along with it to
be used in the final call.</p>
<p>So we are now using a configuration, time to actually do the configuration.</p>
<p>For this global option we'll use
a <a href="https://docs.microsoft.com/en-us/dotnet/fundamentals/code-analysis/configuration-files#global-analyzerconfig">global AnalyzerConfig file</a>
. file. These files look like an <code>.editorconfig</code> file, but everything is
at the top level. The preferred naming convention is <code>generatorname.globalconfig</code>. E.g. if our generator was
named <code>CssClassGenerator</code> our file name would be
<code>cssclassgenerator.globalconfig</code></p>
<p>For example, if we wanted to configure our regex to look for <code>class</code> and <code>cssclass</code> tags our config</p>
<pre><code class="language-text">is_global = true

parser_regex = (class\s*=\s*[\'\&quot;](?&lt;value&gt;[^&lt;]*?)[\'\&quot;])|(cssclass\s*=\s*[\'\&quot;](?&lt;value&gt;[^&lt;]*?)[\'\&quot;])
</code></pre>
<p>We'll put this file in the root of our project. But we still aren't done! Our last step is to tell msbuild about it.
This requires adding a new element named <code>GlobalAnalyzerConfigFiles</code>to provide the value.</p>
<pre><code class="language-xml">&lt;ItemGroup&gt;
    &lt;GlobalAnalyzerConfigFiles Include=&quot;cssclassgenerator.globalconfig&quot;/&gt;
&lt;/ItemGroup&gt;
</code></pre>
<p>Once this is all in place you can finally build and see our configured values in place!</p>
</div>
                <div class="pb-6 pt-6 text-sm text-primary-300"><a target="_blank" rel="noopener noreferrer" href="https://github.com/BlazorStatic/Thirty25.Web/tree/main/Content/Blog/2022/05/adding-config-to-incremental-generator">View on GitHub</a></div></div>
            <footer><div class=" text-sm font-medium leading-5 divide-primary-700 xl:col-start-1 xl:row-start-2 xl:divide-y"><div class="py-4 xl:py-8"><h2 class="text-xs uppercase tracking-wide text-primary-400">Tags</h2>
                        <div class="flex flex-wrap"><a class="text-primary-500 hover:text-primary-400 mr-3 text-sm font-medium uppercase" href="tags/Source Generators">Source Generators</a></div></div></div>
                <div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-400" aria-label="Back to the home" href>← Back to the home</a></div></footer></div></div></article></main>

        <footer></footer>
        <blazor-focus-on-navigate selector="h1"></blazor-focus-on-navigate></body>
<script>
    function swapTheme(){
        if (document.documentElement.classList.contains('dark')) {
            document.documentElement.classList.remove('dark');
            localStorage.theme = 'light';
        } else {
            document.documentElement.classList.add('dark');
            localStorage.theme = 'dark';
        }
    }
</script>

<script type="module">
    import {
        common,
        createStarryNight
    } from 'https://esm.sh/@wooorm/starry-night@3?bundle'
    import {toDom} from 'https://esm.sh/hast-util-to-dom@4?bundle'

    const starryNight = await createStarryNight(common)
    const prefix = 'language-'

    const nodes = Array.from(document.body.querySelectorAll('code'))

    for (const node of nodes) {
        const className = Array.from(node.classList).find(function (d) {
            return d.startsWith(prefix)
        })
        if (!className) continue
        const scope = starryNight.flagToScope(className.slice(prefix.length))
        if (!scope) continue
        const tree = starryNight.highlight(node.textContent, scope)
        node.replaceChildren(toDom(tree, {fragment: true}))
    }
</script></html>