<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://esm.sh/@wooorm/starry-night@3/style/both">
    <base href="/">
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    </head>

<body class="antialiased font-sans bg-primary-50 dark:bg-primary-950 transition-colors"><header class="sticky top-0 left-2 w-full backdrop-blur bg-primary-200 dark:bg-primary-900/70 border-b border-primary-900/20 dark:border-primary-50/10 shadow-md dark:shadow-lg py-2 md:py-4 z-50"><nav class="mx-auto max-w-5xl px-4 md:px-8 xl:px-0 flex  items-center"><img src="/Content/Blog/media/avatar.svg" alt="Avatar image" class="inline-block h-10 w-10 md:h-12 md:w-12 mr-4  rounded-full shadow-md bg-gradient-to-br from-accent-800 to-accent-500 dark:from-accent-500 dark:to-accent-300">
        <h1><a class="font-extrabold text-2xl md:text-4xl text-primary-700 dark:text-primary-300" href="/">Thirty25</a></h1>
        <div class="ml-auto flex items-center"><button aria-label="Toggle Dark Mode" class="mr-6 dark:text-yellow-300 stroke-1 opacity-80" onclick="swapTheme()"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg></button>
            <a class="text-primary-600 hover:text-primary-300 transition-all hover:scale-105" title="Blog source" href="https://github.com/phil-scott-78/thirty25-statiq"><svg width="2rem" height="2rem" class="fill-current" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" transform="scale(64)"></path></svg></a></div></nav></header>

        <main class="mx-auto max-w-5xl px-4 md:px-8 xl:px-0 mt-4 mb-4 md:mb-16"><article><div class="xl:divide-y  xl:divide-primary-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt>
                        <dd class="text-base font-medium leading-6 text-primary-400"><time datetime="2022-05-30T00:00:00.000">May 30, 2022</time></dd></div></dl>
                <div class="prose prose-stone dark:prose-invert mx-auto"><h1 class>Tour of the thirty25.com Repository</h1></div></div></header>
        <div class="grid-rows-[auto_1fr] divide-y  pb-8 divide-primary-700 xl:grid xl:grid-cols-4 xl:gap-x-6 xl:divide-y-0"><div class="divide-y  divide-primary-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="prose prose-stone dark:prose-invert mt-8 prose-sm md:prose-base lg:prose-lg max-w-full dark:font-light lg:leading-loose"><p>The repository for generating this site has quite a few features built on top of <a href="https://www.statiq.dev/">statiq</a>. You are welcome to fork it and use it for your own blog, but I wanted to document some of the features that might be overlooked or confusing.</p>
<p>Repository is located here <a href="https://github.com/phil-scott-78/thirty25-statiq">https://github.com/phil-scott-78/thirty25-statiq</a>. To run a live preview just run <code>dotnet run -- preview</code></p>
<h2 id="new-post-command"><code>New-Post</code> command</h2>
<p>It has a few helper commands, using Spectre.Console, to help maintain the site. new-post will create a new post with a title, description, its tags and date, then create a new branch and open vscode on the file.</p>
<p>To run execute</p>
<pre><code class="language-bash"> dotnet run -- new-post -e -b &quot;Tour of the thirty25.com repository&quot;
</code></pre>
<p>The <code>-b</code> creates a new branch and <code>-e</code> launches VS Code. I like to put new posts in branches because it sometimes takes me way too long to get around to finishing them up, and often time I'm distracted and add new features to the blog instead.</p>
<p><a href="https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/NewPostCommand.cs">https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/NewPostCommand.cs</a></p>
<p><img src="/Content/Blog/media/2022-05-30-02-19-19.png" alt="New-Post" /></p>
<p>png-compress is another command. It looks at all files edited or untracked for the current commit and uses TinyPng to compress them. You can find that command here.</p>
<p><a href="https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/PngCompress.cs">https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/PngCompress.cs</a></p>
<h2 id="png-compress-command"><code>Png-Compress</code> command</h2>
<p><code>png-compress</code> will send all .png files that are part of the current commit or untracked to tinypng.com's API. This is a relatively slow operation using a service with limits, so doing this on demand only for files that have been recently edited can keep our build time low while also being able to use the free tier from <a href="https://tinypng.com/developers">tinypng's developer portal</a></p>
<p>To use you'll need an API key from tinypng and set its value with a <code>TinyPngKey</code> environmental variable</p>
<p><a href="https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/PngCompress.cs">https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/PngCompress.cs</a></p>
<p><img src="/Content/Blog/media/2022-05-30-02-28-36.png" alt="running png-compress" /></p>
<h2 id="roslyn-highlighting">Roslyn highlighting</h2>
<p>While the site is configured to use prism.js to highlight code blocks, prism relies on an out of date parser for C#. As new features are added to C# it lags behind significantly or doesn't support some parts of the language at all. So, instead we are using Roslyn to provide the color highlighting server side. This gets us better highlighting and better client perf as a bonus. Prism is left configured to highlight other code blocks such as SQL statements and Powershell.</p>
<p><a href="https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/RoslynHighlightModule.cs">https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/RoslynHighlightModule.cs</a></p>
<h2 id="social-cards">Social cards</h2>
<p>Social cards are generated for each post using an <a href="https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/SocialCard.cshtml">ASP.NET razor file</a> to convert the razor output to a png using Playwright.</p>
<p><img src="/Content/Blog/media/2022-05-30-02-34-53.png" alt="Social media card in action" /></p>
<p><a href="https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/Pipelines/SocialImages.cs">https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/Pipelines/SocialImages.cs</a></p>
<h2 id="monorailcss-for-the-styling">MonorailCSS for the styling</h2>
<p>There is no CSS or SASS files part of the repository. The CSS for the site is a utility-first CSS framework inspired by Tailwind named <a href="https://github.com/monorailcss/MonorailCss.Framework">MonorailCSS</a>. The pipeline gathers up all the CSS classes in the output files using AngleSharp and sends them to MonorailCss.Framework. MonorailCss takes those CSS classes and generates an appropriate stylesheet which is then persisted with the rest of the static site.</p>
<p>One gotcha for those looking to add this to your Statiq site - since it needs the full output of the site to work it is marked as part of the deployment process. If you are also running a deployment command like publishing to netlify you are likely to run into conditions where the publish command runs before the CSS generation.</p>
<p><a href="https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/Pipelines/Monorail.cs">https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/Pipelines/Monorail.cs</a></p>
<h2 id="publish-the-site-as-a-book">Publish the site as a book</h2>
<p>And finally the book output. The book is generated by gathering all the posts up and combining them into one document. That document is fed to a razor page that uses <a href="https://pagedjs.org/">paged.js</a> to handle dividing the site up into a book format. It not only applies printer friendly styling, but also adds things like custom headers and footers, a table of contents, and footnotes containing the URLs for hyperlinks all with our specified page dimensions for printing.</p>
<p>This razor page is then hosted in a minimal ASPNET instance and Playwright is used to generate a PDF of the output.</p>
<p><a href="https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/Pipelines/Book.cs">https://github.com/phil-scott-78/thirty25-statiq/blob/main/Statiq/Pipelines/Book.cs</a></p>
<h2 id="configuring-statiq">Configuring Statiq</h2>
<p>With this many custom hooks into Statiq, we need to tell the Statiq bootstrapper about them all. We also need to modify some of the default pipelines to either replace
or add in some of our own modules too.</p>
<pre><code class="language-csharp">await Bootstrapper.Factory
    .CreateWeb(args)
    // used to link social cards from the layout page. They require an absolute path
    // including the domain name. This short code helps with that.
    .AddShortcode&lt;FullUrlShortCode&gt;(&quot;FullUrl&quot;)
    // The monorail pipeline takes in an instance of the CSS framework so we need to configure it.
    .ConfigureServices(i =&gt;
    {
        i.AddSingleton(GetCssFramework());
    })
    // we need to modify the Content pipeline
    .ModifyPipeline(nameof(Content), pipeline =&gt;
    {
        // the default GatherHeadings module doesn't include child content like code blocks, so we need to swap it with one
        // that is configured to parse all the nested elements.
        pipeline.ProcessModules
            .GetLast&lt;CacheDocuments&gt;().Children
            .GetLast&lt;ExecuteIf&gt;()[0]
            .ReplaceFirst&lt;GatherHeadings&gt;(_ =&gt; true, new GatherHeadings(2).WithNestedElements());
        // in addition to the archive pipeline we also have the book so make sure the regular content skips those too
        pipeline.ProcessModules
            .ReplaceFirst&lt;FilterDocuments&gt;(
                _ =&gt; true,
                new FilterDocuments(Config.FromDocument(doc =&gt; !Archives.IsArchive(doc) &amp;&amp; !Book.IsBook(doc))));
        // include our custom highlighting module after the HTML has been generated in the process modules.
        pipeline.PostProcessModules.Add(new RoslynHighlightModule());
    })
    // the playwright nuget package relies on external resources like chrome to run. we can use the dotnet playwright
    // tool to install them.
    .AddProcess(ProcessTiming.Initialization,
        _ =&gt; new ProcessLauncher(dotnetPath, &quot;tool restore&quot;) { LogErrors = false })
    .AddProcess(ProcessTiming.Initialization,
        _ =&gt; new ProcessLauncher(dotnetPath, &quot;tool run playwright install chromium&quot;) { LogErrors = false })
    .RunAsync();
</code></pre>
</div>
                <div class="pb-6 pt-6 text-sm text-primary-300"><a target="_blank" rel="noopener noreferrer" href="https://github.com/BlazorStatic/Thirty25.Web/tree/main/Content/Blog/2022/05/tour-of-the-thirty25.com-repository">View on GitHub</a></div></div>
            <footer><div class=" text-sm font-medium leading-5 divide-primary-700 xl:col-start-1 xl:row-start-2 xl:divide-y"><div class="py-4 xl:py-8"><h2 class="text-xs uppercase tracking-wide text-primary-400">Tags</h2>
                        <div class="flex flex-wrap"><a class="text-primary-500 hover:text-primary-400 mr-3 text-sm font-medium uppercase" href="tags/statiq">statiq</a></div></div></div>
                <div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-400" aria-label="Back to the home" href>← Back to the home</a></div></footer></div></div></article></main>

        <footer></footer>
        <blazor-focus-on-navigate selector="h1"></blazor-focus-on-navigate></body>
<script>
    function swapTheme(){
        if (document.documentElement.classList.contains('dark')) {
            document.documentElement.classList.remove('dark');
            localStorage.theme = 'light';
        } else {
            document.documentElement.classList.add('dark');
            localStorage.theme = 'dark';
        }
    }
</script>

<script type="module">
    import {
        common,
        createStarryNight
    } from 'https://esm.sh/@wooorm/starry-night@3?bundle'
    import {toDom} from 'https://esm.sh/hast-util-to-dom@4?bundle'

    const starryNight = await createStarryNight(common)
    const prefix = 'language-'

    const nodes = Array.from(document.body.querySelectorAll('code'))

    for (const node of nodes) {
        const className = Array.from(node.classList).find(function (d) {
            return d.startsWith(prefix)
        })
        if (!className) continue
        const scope = starryNight.flagToScope(className.slice(prefix.length))
        if (!scope) continue
        const tree = starryNight.highlight(node.textContent, scope)
        node.replaceChildren(toDom(tree, {fragment: true}))
    }
</script></html>