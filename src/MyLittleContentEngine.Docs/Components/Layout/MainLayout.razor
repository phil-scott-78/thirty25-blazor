@using System.Collections.Immutable
@using MyLittleContentEngine.Services.Content.TableOfContents
@using Microsoft.AspNetCore.Components.Sections
@inherits LayoutComponentBase
@inject TableOfContentService TableOfContentService
@inject NavigationManager NavigationManager

<div class="bg-base-50 dark:bg-base-900 text-base-950 dark:text-base-100 min-h-screen dark:scheme-dark">
    <BaseHeader
        HeaderClass="transition-all sticky top-0 w-full bg-base-900/90 backdrop-blur backdrop-grayscale px-4 py-2 sm:py-3 md:py-4 lg:py-6 xl:py-8 mb-4 border-b border-primary-700 dark:border-primary-500/25 shadow-md z-50"
        NavClass="mx-auto max-w-8xl transition-all flex items-center"
        TitleClass="transition-all font-extrabold text-2xl md:text-4xl text-base-100 dark:text-base-100 text-shadow-sm text-shadow-primary-400"
        ExtraButtons="@mobileMenuButton"/>
    <div class="max-w-8xl mx-auto px-4">

        <div class="flex flex-col md:flex-row lg:gap-x-8 gap-x-12">
            <aside id="nav-sidebar" class="w-full lg:w-64 flex-none lg:sticky lg:top-36 lg:h-[calc(100vh-9rem)] overflow-x-hidden overflow-y-auto lg:block hidden">
                <TableOfContentsNavigation TableOfContents="@_toc"/>
            </aside>
            <main class="flex-1 w-full md:w-auto min-w-0 mt-2 lg:mt-8">
                @Body
            </main>

            <aside
                class="w-72 flex-none px-4 sticky top-36 h-[calc(100vh-9rem)] overflow-x-hidden overflow-y-auto hidden xl:block">
                <SectionOutlet SectionName="sidebar"/>
            </aside>

        </div>
    </div>
</div>

@code{
    private ImmutableList<TableOfContentEntry>? _toc;

    [Parameter] public RenderFragment? SidebarChildContent { get; set; }

    private readonly RenderFragment mobileMenuButton =
        @<button id="menu-toggle"
                 class="lg:hidden p-2 text-primary-50 rounded-md hover:bg-primary-800 focus:outline-none focus:ring-2 focus:ring-primary-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>;

    protected override async Task OnInitializedAsync()
    {
        // need to somehow standardize this to match what we think
        _toc = await TableOfContentService.GetNavigationTocAsync(NavigationManager.ToAbsoluteUri(NavigationManager.Uri).AbsolutePath);
        await base.OnInitializedAsync();
    }

}
